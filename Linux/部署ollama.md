### 部署ollama
- 导出、导入模型库
  - 导出模型
    ```bash
    # 查看所有的模型
    ollama list

    NAME               ID              SIZE      MODIFIED
    deepseek-r1:14b    7db3f9e75b3d    9.0 GB    2 hours ago
    qwen2:latest       9ad095c8e788    4.4 GB    2 hours ago

    # 查看模型信息
    ollama show --modelfile deepseek-r1:14b

    # Modelfile generated by "ollama show"
    # To build a new Modelfile based on this, replace FROM with:
    # FROM deepseek-r1:14b

    FROM /usr/share/ollama/.ollama/models/blobs/  sha256-6e9f90f02bb3b39b59e81916e8cfce9deb45aeaeb9a54a5be4414486b907dc1e
    TEMPLATE """{{- if .System }}{{ .System }}{{ end }}
    {{- range $i, $_ := .Messages }}
    {{- $last := eq (len (slice $.Messages $i)) 1}}
    {{- if eq .Role "user" }}<｜User｜>{{ .Content }}
    {{- else if eq .Role "assistant" }}<｜Assistant｜>{{ .Content }}{{- if not $last }}  <｜end▁of▁sentence｜>{{- end }}
    {{- end }}
    {{- if and $last (ne .Role "assistant") }}<｜Assistant｜>{{- end }}
    {{- end }}"""
    PARAMETER stop <｜begin▁of▁sentence｜>
    PARAMETER stop <｜end▁of▁sentence｜>
    PARAMETER stop <｜User｜>
    PARAMETER stop <｜Assistant｜>
    LICENSE """MIT License

    Copyright (c) 2023 DeepSeek

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    """

    # FROM /usr/share/ollama/.ollama/models/blobs/sha256-6e9f90f02bb3b39b59e81916e8cfce9deb45aeaeb9a54a5be4414486b907dc1e。从这个字段信息得知，文件保存的位置。直接把文件复制处理就可以
    ```
  - 导入模型
    ```bash
    # 编辑配置文件
    ollama show --modelfile deepseek-r1:14b > modelfile.txt

    # 修改modelfile.txt中的FROM字段，修改为当前模型的路径。导入文件
    ollama create deepseek-r1:14b --modelfile modelfile.txt
    ```
- 离线安装，这里以0.5.8版本为例子。而且已经安装nvidia的显卡驱动与cude开发套件
  ```bash
  # 在github中下载对应的压缩包，https://github.com/ollama/ollama/releases/
  wget https://github.com/ollama/ollama/releases/download/v0.5.8/ollama-linux-amd64.tgz

  # 下载ollama的在线安装脚本
  wget https://ollama.com/install.sh

  # 修改脚本内容，将status "Downloading Linux ${ARCH} bundle"下的curl的语句注释
  # 修改tar命令解压的文件名
  $SUDO tar -xzf - -C "$OLLAMA_INSTALL_DIR"
  $SUDO tar -xzf ollama-linux-amd64.tgz -C "$OLLAMA_INSTALL_DIR"
  
  # 执行install.sh脚本
  bash install.sh

  # 输出一下内容表示成功安装
  >>> Cleaning up old version at /usr/local/lib/ollama
  >>> Installing ollama to /usr/local
  >>> Downloading Linux amd64 bundle
  >>> Adding ollama user to render group...
  >>> Adding ollama user to video group...
  >>> Adding current user to ollama group...
  >>> Creating ollama systemd service...
  >>> Enabling and starting ollama service...
  >>> NVIDIA GPU installed.
  ```
- 使用docker运行ollama。
  - 安装的环境
    - ubuntu 22.04.5
    - docker 27.5.1
    - 显卡 Quadro RTX 5000
    - 需要已经安装好显卡驱动
  1. 需要安装Nvidia Container Toolkit
     ```bash
     # 配置软件库
     curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
       && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
         sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
         sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list
     # 从存储库更新软件包列表：
     sudo apt update

     # 安装NVIDIA Container Toolkit 相关包
     sudo apt-get install -y nvidia-container-toolkit
     ```
  2. 修改docker配置文件
     ```bash
     # The nvidia-ctk command modifies the /etc/docker/daemon.json file on the host. The file is updated so that Docker can use the NVIDIA Container Runtime.
     sudo nvidia-ctk runtime configure --runtime=docker

     # 重启docker
     sudo systemctl restart docker
     ```
  3. 测试，运行ubuntu镜像，执行nvidia-smi查询显卡信息
     ```bash
     sudo docker run --rm --runtime=nvidia --gpus all ubuntu nvidia-smi
  
     # 一切正常会显示以下信息
     +-----------------------------------------------------------------------------+
     | NVIDIA-SMI 535.86.10    Driver Version: 535.86.10    CUDA Version: 12.2     |
     |-------------------------------+----------------------+----------------------+
     | GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
     | Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
     |                               |                      |               MIG M. |
     |===============================+======================+======================|
     |   0  Tesla T4            On   | 00000000:00:1E.0 Off |                    0 |
     | N/A   34C    P8     9W /  70W |      0MiB / 15109MiB |      0%      Default |
     |                               |                      |                  N/A |
     +-------------------------------+----------------------+----------------------+

     +-----------------------------------------------------------------------------+
     | Processes:                                                                  |
     |  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
     |        ID   ID                                                   Usage      |
     |=============================================================================|
     |  No running processes found                                                 |
     +-----------------------------------------------------------------------------+
     ```
---
### 参考信息
1. [Ollama Docker 镜像部署](https://www.zhihu.com/tardis/zm/art/697875797?source_id=1003)
2. [NVIDIA Container Toolkit](https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html)